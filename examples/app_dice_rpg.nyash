// ğŸ² ã‚µã‚¤ã‚³ãƒ­RPGãƒãƒˆãƒ« - RandomBoxã¨DebugBoxã‚’æ´»ç”¨ã—ãŸæˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ ï¼

print("âš”ï¸ === Dice RPG Battle ===" )
print("RandomBoxã‚’ä½¿ã£ãŸãƒ€ã‚¤ã‚¹ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ \n")

// ãƒ‡ãƒãƒƒã‚°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
DEBUG = new DebugBox()
DEBUG.startTracking()

// æˆ¦é—˜ãƒ­ã‚°è¨˜éŒ²ç”¨
battleLog = new ArrayBox()

// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼Boxå®šç¾©
box Character {
    init {
        name,
        hp,
        maxHp,
        attack,
        defense,
        dice,
        math
    }
    
    // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹
    func takeDamage(damage) {
        me.hp = me.hp - damage
        if (me.hp < 0) {
            me.hp = 0
        }
    }
    
    // ç”Ÿå­˜ç¢ºèª
    func isAlive() {
        return me.hp > 0
    }
    
    // HPè¡¨ç¤ºï¼ˆæ•´æ•°æ¼”ç®—ã®ã¿ï¼‰
    func getHpBar() {
        // HPæ¯”ç‡ã‚’10å€ã—ã¦è¨ˆç®— (HP * 10) / maxHP
        hpx10 = me.hp * 10
        
        // æ•´æ•°é™¤ç®—ã‚’æ‰‹å‹•å®Ÿè£…
        filled = 0
        temp = hpx10
        loop(temp >= me.maxHp) {
            temp = temp - me.maxHp
            filled = filled + 1
        }
        
        // filledãŒ10ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
        if (filled > 10) {
            filled = 10
        }
        
        bar = "["
        i = 0
        loop(i < 10) {
            if (i < filled) {
                bar = bar + "â– "
            } else {
                bar = bar + "â–¡"
            }
            i = i + 1
        }
        bar = bar + "]"
        return bar
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    func showStatus() {
        print(me.name + " HP: " + me.hp + "/" + me.maxHp + " " + me.getHpBar())
        print("  ATK: " + me.attack + " DEF: " + me.defense)
    }
}

// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆé–¢æ•°
function createCharacter(name, hp, attack, defense) {
    char = new Character()
    char.name = name
    char.hp = hp
    char.maxHp = hp
    char.attack = attack
    char.defense = defense
    char.dice = new RandomBox()
    char.math = new MathBox()
    DEBUG.trackBox(char, "Character-" + name)
    return char
}

// ãƒãƒˆãƒ«å®Ÿè¡Œé–¢æ•°
function performAttack(attacker, defender) {
    print("\nâš”ï¸ " + attacker.name + " ã®æ”»æ’ƒï¼")
    
    // æ”»æ’ƒãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ« (1-6)
    attackRoll = attacker.dice.randInt(1, 6)
    print("ğŸ² æ”»æ’ƒãƒ€ã‚¤ã‚¹: " + attackRoll)
    
    // é˜²å¾¡ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ« (1-6)
    defenseRoll = defender.dice.randInt(1, 6)
    print("ğŸ›¡ï¸ " + defender.name + " ã®é˜²å¾¡ãƒ€ã‚¤ã‚¹: " + defenseRoll)
    
    // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
    baseDamage = attacker.attack + attackRoll
    defense = defender.defense + defenseRoll
    damage = baseDamage - defense
    
    if (damage < 0) {
        damage = 0
    }
    
    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š (6ãŒå‡ºãŸã‚‰2å€)
    if (attackRoll == 6) {
        print("ğŸ’¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆï¼")
        damage = damage * 2
    }
    
    // ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨
    defender.takeDamage(damage)
    
    if (damage > 0) {
        print("ğŸ’¢ " + defender.name + " ã« " + damage + " ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼")
    } else {
        print("ğŸ›¡ï¸ " + defender.name + " ã¯æ”»æ’ƒã‚’å®Œå…¨ã«é˜²ã„ã ï¼")
    }
    
    // ãƒãƒˆãƒ«ãƒ­ã‚°ã«è¨˜éŒ²
    logEntry = attacker.name + " â†’ " + defender.name + ": " + damage + " damage"
    battleLog.push(logEntry)
    
    return damage
}

// ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ 
print("\nğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼\n")

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚¨ãƒãƒŸãƒ¼ä½œæˆ
player = createCharacter("å‹‡è€…", 50, 10, 5)
enemy = createCharacter("ã‚´ãƒ–ãƒªãƒ³", 30, 8, 3)

// åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
print("ğŸ“Š åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:")
player.showStatus()
enemy.showStatus()

// ãƒãƒˆãƒ«ãƒ«ãƒ¼ãƒ—
turn = 1
battleContinue = true
loop(battleContinue) {
    print("\n========== ã‚¿ãƒ¼ãƒ³ " + turn + " ==========")
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
    if (player.isAlive()) {
        performAttack(player, enemy)
    }
    
    // ã‚¨ãƒãƒŸãƒ¼ã®ã‚¿ãƒ¼ãƒ³
    if (enemy.isAlive()) {
        performAttack(enemy, player)
    }
    
    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    print("\nğŸ“Š ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:")
    player.showStatus()
    enemy.showStatus()
    
    // çµ‚äº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    playerAlive = player.isAlive()
    enemyAlive = enemy.isAlive()
    
    if (not playerAlive) {
        battleContinue = false
    }
    if (not enemyAlive) {
        battleContinue = false
    }
    
    turn = turn + 1
    
    // å®‰å…¨è£…ç½®ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if (turn > 50) {
        print("\nâ±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼å¼•ãåˆ†ã‘ï¼")
        break
    }
}

// å‹æ•—åˆ¤å®š
print("\nğŸ === ãƒãƒˆãƒ«çµ‚äº†ï¼ ===")
playerAlive = player.isAlive()
enemyAlive = enemy.isAlive()

if (playerAlive) {
    if (not enemyAlive) {
        print("ğŸ‰ å‹‡è€…ã®å‹åˆ©ï¼")
    } else {
        print("ğŸ¤ å¼•ãåˆ†ã‘ï¼")
    }
} else {
    if (enemyAlive) {
        print("ğŸ’€ ã‚´ãƒ–ãƒªãƒ³ã®å‹åˆ©...")
    } else {
        print("ğŸ¤ å¼•ãåˆ†ã‘ï¼")
    }
}

// ãƒãƒˆãƒ«ãƒ­ã‚°è¡¨ç¤º
print("\nğŸ“œ === ãƒãƒˆãƒ«ãƒ­ã‚° ===")
i = 0
loop(i < battleLog.length()) {
    print("[" + (i + 1) + "] " + battleLog.get(i))
    i = i + 1
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±
print("\nğŸ’¾ === ãƒ¡ãƒ¢ãƒªãƒ¬ãƒãƒ¼ãƒˆ ===")
print(DEBUG.memoryReport())

print("\nâœ… Dice RPG Battle completed!")