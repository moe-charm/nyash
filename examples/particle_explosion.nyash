// ğŸŒŸ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™ºã‚·ã‚¹ãƒ†ãƒ  - Everything is Box ã®ç¾ã—ã„å®Ÿè¨¼
// WebCanvasBox + RandomBox + MathBox ã®å®Œç’§ãªçµ±åˆ

print("ğŸŒŸ === Particle Explosion System Starting ===")

// ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
DEBUG = new DebugBox()
DEBUG.startTracking()

// ğŸ¨ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«Box - å„ç²’å­ãŒç‹¬ç«‹ã—ãŸBoxï¼
box ParticleBox {
    init { x, y, vx, vy, color, size, life, maxLife, gravity }
    
    ParticleBox(startX, startY) {
        // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆå™¨
        random = new RandomBox()
        
        // åˆæœŸä½ç½®
        me.x = startX
        me.y = startY
        
        // ãƒ©ãƒ³ãƒ€ãƒ é€Ÿåº¦ï¼ˆçˆ†ç™ºåŠ¹æœï¼‰
        angle = random.float() * 6.28318  // 2Ï€
        speed = random.float() * 5.0 + 2.0
        me.vx = speed * new MathBox().cos(angle)
        me.vy = speed * new MathBox().sin(angle) - 3.0  // ä¸Šå‘ãåˆé€Ÿåº¦
        
        // ãƒ©ãƒ³ãƒ€ãƒ è‰²ï¼ˆè™¹è‰²ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰
        colorChoice = random.integer(1, 6)
        if colorChoice == 1 { me.color = "red" }
        if colorChoice == 2 { me.color = "orange" }
        if colorChoice == 3 { me.color = "yellow" }
        if colorChoice == 4 { me.color = "lime" }
        if colorChoice == 5 { me.color = "cyan" }
        if colorChoice == 6 { me.color = "magenta" }
        
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç‰¹æ€§
        me.size = random.float() * 4.0 + 2.0
        me.maxLife = 100
        me.life = me.maxLife
        me.gravity = 0.1
    }
    
    // ç‰©ç†æ›´æ–°
    update() {
        // é‡åŠ›é©ç”¨
        me.vy = me.vy + me.gravity
        
        // ä½ç½®æ›´æ–°
        me.x = me.x + me.vx
        me.y = me.y + me.vy
        
        // ç©ºæ°—æŠµæŠ—
        me.vx = me.vx * 0.99
        me.vy = me.vy * 0.98
        
        // å¯¿å‘½æ¸›å°‘
        me.life = me.life - 1
        
        // ã‚µã‚¤ã‚ºã‚‚å¯¿å‘½ã¨ã¨ã‚‚ã«å°ã•ã
        ratio = me.life / me.maxLife
        me.size = me.size * 0.995
        
        return me.life > 0
    }
    
    // Canvasæç”»
    draw(canvas) {
        if me.life > 0 {
            // é€æ˜åº¦è¨ˆç®—
            alpha = me.life / me.maxLife
            
            // å††ã‚’æç”»
            canvas.setFillStyle(me.color)
            canvas.beginPath()
            canvas.arc(me.x, me.y, me.size, 0, 6.28318)
            canvas.fill()
            
            // å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå°ã•ã„ç™½ã„ç‚¹ï¼‰
            if me.life > me.maxLife * 0.8 {
                canvas.setFillStyle("white")
                canvas.beginPath()
                canvas.arc(me.x, me.y, me.size * 0.3, 0, 6.28318)
                canvas.fill()
            }
        }
    }
    
    isAlive() {
        return me.life > 0
    }
}

// ğŸ† ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†Box
box ParticleSystemBox {
    init { particles, canvas, centerX, centerY, explosionTimer }
    
    ParticleSystemBox(canvasId, width, height) {
        // WebCanvasåˆæœŸåŒ–
        me.canvas = new WebCanvasBox(canvasId, width, height)
        me.particles = new ArrayBox()
        me.centerX = width / 2
        me.centerY = height / 2
        me.explosionTimer = 0
        
        // èƒŒæ™¯è‰²è¨­å®š
        me.canvas.setFillStyle("black")
        me.canvas.fillRect(0, 0, width, height)
        
        DEBUG.trackBox(me, "ParticleSystem")
    }
    
    // çˆ†ç™ºç”Ÿæˆ
    explode(x, y, count) {
        print("ğŸ’¥ Creating " + count + " particles at (" + x + ", " + y + ")")
        
        i = 0
        loop (i < count) {
            particle = new ParticleBox(x, y)
            me.particles.add(particle)
            DEBUG.trackBox(particle, "Particle_" + i)
            i = i + 1
        }
    }
    
    // ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
    update() {
        // èƒŒæ™¯ã‚¯ãƒªã‚¢ï¼ˆãƒˆãƒ¬ã‚¤ãƒ«åŠ¹æœç”¨ã«å°‘ã—é€æ˜ï¼‰
        me.canvas.setFillStyle("rgba(0,0,0,0.1)")
        me.canvas.fillRect(0, 0, me.canvas.width, me.canvas.height)
        
        // å…¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ›´æ–°
        aliveParticles = new ArrayBox()
        i = 0
        loop (i < me.particles.size()) {
            particle = me.particles.get(i)
            if particle.update() {
                particle.draw(me.canvas)
                aliveParticles.add(particle)
            }
            i = i + 1
        }
        
        me.particles = aliveParticles
        
        // è‡ªå‹•çˆ†ç™ºã‚¿ã‚¤ãƒãƒ¼
        me.explosionTimer = me.explosionTimer + 1
        if me.explosionTimer > 120 {  // 2ç§’é–“éš”
            random = new RandomBox()
            explodeX = random.integer(50, me.canvas.width - 50)
            explodeY = random.integer(50, me.canvas.height - 50)
            particleCount = random.integer(15, 30)
            me.explode(explodeX, explodeY, particleCount)
            me.explosionTimer = 0
        }
        
        // çµ±è¨ˆè¡¨ç¤º
        me.canvas.setFillStyle("white")
        me.canvas.fillText("Particles: " + me.particles.size(), 10, 20)
        me.canvas.fillText("Everything is Box!", 10, 40)
    }
    
    // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ«ãƒ¼ãƒ—
    run(frames) {
        frame = 0
        loop (frame < frames) {
            me.update()
            frame = frame + 1
            
            // ãƒ•ãƒ¬ãƒ¼ãƒ æƒ…å ±
            if frame % 60 == 0 {
                print("ğŸ¬ Frame: " + frame + ", Active particles: " + me.particles.size())
            }
        }
    }
}

// ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼
print("ğŸ¨ Creating particle system...")
system = new ParticleSystemBox("particle-canvas", 800, 600)

// æœ€åˆã®å¤§çˆ†ç™ºï¼
system.explode(400, 300, 50)

print("ğŸ’¥ Initial explosion created!")
print("ğŸŒˆ Rainbow particles with physics!")
print("âœ¨ Each particle is an independent Box!")

// è‡ªå‹•å®Ÿè¡Œãƒ‡ãƒ¢ï¼ˆ300ãƒ•ãƒ¬ãƒ¼ãƒ  = ç´„5ç§’ï¼‰
print("ğŸ® Running automatic particle show...")
system.run(300)

// æœ€çµ‚çµ±è¨ˆ
print(DEBUG.memoryReport())
print("ğŸ† Particle explosion complete!")
print("ğŸ± Everything is Box - Even explosions are beautiful!")