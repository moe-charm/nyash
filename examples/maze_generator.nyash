// ğŸŒ€ è¿·è·¯ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - outboxã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ´»ç”¨ãƒ‡ãƒ¢
// æ£’å€’ã—æ³•ã«ã‚ˆã‚‹è¿·è·¯ç”Ÿæˆ

print("=== Maze Generator with outbox ===")

// Cellã®å®šç¾©ï¼ˆè¿·è·¯ã®1ãƒã‚¹ï¼‰
box Cell {
    init { x, y, wall }
    
    Cell(x_pos, y_pos) {
        me.x = x_pos
        me.y = y_pos
        me.wall = true  // åˆæœŸçŠ¶æ…‹ã¯å£
    }
    
    makePassage() {
        me.wall = false
    }
    
    isWall() {
        return me.wall
    }
}

// è¿·è·¯Boxå®šç¾©
box Maze {
    init { width, height, cells }
    
    Maze(w, h) {
        me.width = w
        me.height = h
        me.cells = new MapBox()  // åº§æ¨™â†’Cellã®ãƒãƒƒãƒ—
        
        // åˆæœŸåŒ–ï¼šå…¨éƒ¨å£ã«ã™ã‚‹
        local y, x, key, cell
        y = 0
        loop(y < h) {
            x = 0
            loop(x < w) {
                key = x + "," + y
                cell = new Cell(x, y)
                me.cells.set(key, cell)
                x = x + 1
            }
            y = y + 1
        }
    }
    
    // åº§æ¨™ã‹ã‚‰Cellã‚’å–å¾—
    getCell(x, y) {
        local key
        key = x + "," + y
        return me.cells.get(key)
    }
    
    // è¿·è·¯ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼šå¤–å‘¨ä»¥å¤–ã‚’é€šè·¯ã«ã™ã‚‹ï¼‰
    generate() {
        print("Generating maze...")
        
        // ã¾ãšé€šè·¯ã‚’ä½œã‚‹ï¼ˆ1ãƒã‚¹ãŠãã«ï¼‰
        local y, x, cell
        y = 1
        loop(y < me.height - 1) {
            x = 1
            loop(x < me.width - 1) {
                // å¥‡æ•°åº§æ¨™ã‚’é€šè·¯ã«ã™ã‚‹
                if isOdd(x) && isOdd(y) {
                    cell = me.getCell(x, y)
                    cell.makePassage()
                }
                x = x + 1
            }
            y = y + 1
        }
        
        // æ£’å€’ã—æ³•ã§å£ã‚’ä½œã‚‹
        y = 2
        loop(y < me.height - 2) {
            if isEven(y) {
                x = 2
                loop(x < me.width - 2) {
                    if isEven(x) {
                        me.placeRandomWall(x, y)
                    }
                    x = x + 2
                }
            }
            y = y + 2
        }
    }
    
    // ãƒ©ãƒ³ãƒ€ãƒ ã«å£ã‚’ç½®ã
    placeRandomWall(x, y) {
        // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã‚’é¸ã¶ï¼ˆç°¡æ˜“ç‰ˆï¼šå›ºå®šãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        local pattern, dir, dx, dy, targetX, targetY, key
        pattern = (x + y) * 7  // ç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ 
        dir = pattern - (pattern >= 4) * 4  // 0-3ã®å€¤
        
        dx = 0
        dy = 0
        
        if dir == 0 { 
            dx = 0
            dy = -1 
        }   // ä¸Š
        if dir == 1 { 
            dx = 1
            dy = 0 
        }    // å³
        if dir == 2 { 
            dx = 0
            dy = 1 
        }    // ä¸‹
        if dir == 3 { 
            dx = -1
            dy = 0 
        }   // å·¦
        
        targetX = x + dx
        targetY = y + dy
        key = targetX + "," + targetY
        
        // MapBox.hasã‚’ä½¿ã£ã¦ã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèª
        if me.cells.has(key) {
            local cell
            cell = me.getCell(targetX, targetY)
            cell.wall = true
        }
    }
    
    // è¿·è·¯ã‚’è¡¨ç¤º
    display() {
        print("\nGenerated Maze:")
        local y, x, line, cell
        y = 0
        loop(y < me.height) {
            line = ""
            x = 0
            loop(x < me.width) {
                cell = me.getCell(x, y)
                if cell.isWall() {
                    line = line + "â– "
                } else {
                    line = line + "  "
                }
                x = x + 1
            }
            print(line)
            y = y + 1
        }
    }
}

// MazeFactoryå®šç¾©
box MazeFactory {
    init { dummy }
}

// staticé–¢æ•°ã§outboxã‚’ä½¿ç”¨
static function MazeFactory.create(width, height) {
    print("MazeFactory.create called with size: " + width + "x" + height)
    
    // outboxå¤‰æ•°ã§è¿·è·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    outbox maze
    maze = new Maze(width, height)
    
    // localå¤‰æ•°ã‚‚ä½¿ã†
    local message
    message = "Creating maze of size " + width + "x" + height
    print(message)
    
    // è¿·è·¯ã‚’ç”Ÿæˆ
    maze.generate()
    
    return maze  // æ‰€æœ‰æ¨©ã‚’å‘¼ã³å‡ºã—å´ã«ç§»è»¢
}

// è¤‡æ•°ã®è¿·è·¯ã‚’ä½œã‚‹ãƒ‡ãƒ¢
static function MazeFactory.createMultiple() {
    print("\nCreating multiple mazes...")
    
    outbox small, medium, large
    
    small = MazeFactory.create(11, 7)
    medium = MazeFactory.create(21, 11)
    large = MazeFactory.create(31, 15)
    
    // æœ€åˆã®è¿·è·¯ã ã‘è¿”ã™ï¼ˆä»–ã¯ç ´æ£„ã•ã‚Œã‚‹ï¼‰
    return small
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆ%æ¼”ç®—å­ãŒãªã„ãŸã‚å·¥å¤«ï¼‰
function isOdd(n) {
    // n % 2 == 1 ã®ä»£æ›¿å®Ÿè£…
    local half
    half = 0
    loop(half * 2 < n) {
        half = half + 1
    }
    return (n - half * 2) == 1
}

function isEven(n) {
    // n % 2 == 0 ã®ä»£æ›¿å®Ÿè£…
    local half
    half = 0
    loop(half * 2 < n) {
        half = half + 1
    }
    return (n - half * 2) == 0
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
print("\n--- Small Maze (11x7) ---")
maze1 = MazeFactory.create(11, 7)
maze1.display()

print("\n--- Medium Maze (21x11) ---")
maze2 = MazeFactory.create(21, 11)
maze2.display()

print("\n--- Multiple Maze Creation Test ---")
firstMaze = MazeFactory.createMultiple()
print("\nFirst maze from multiple creation:")
firstMaze.display()

print("\n=== Maze Generator completed! ===")
print("Note: Outbox variables successfully transferred ownership!")