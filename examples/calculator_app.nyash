// ğŸ§® Nyashæ•°å¼ãƒ‘ãƒ¼ã‚µãƒ¼ - Everything is Boxå“²å­¦ã«ã‚ˆã‚‹å®Ÿè£…
// å†å¸°ä¸‹é™æ§‹æ–‡è§£æ + ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ä»˜ã

print("ğŸ§® === Nyash Calculator App ===")

// ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½åˆæœŸåŒ–
DEBUG = new DebugBox()
DEBUG.startTracking()

// ğŸ¯ ãƒˆãƒ¼ã‚¯ãƒ³Box - ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒBox
box Token<T> {
    init { type, value, position }
    
    Token(tokenType, tokenValue) {
        me.type = tokenType
        me.value = tokenValue
        me.position = 0
    }
    
    toString() {
        return "Token(" + me.type + ": " + me.value + ")"
    }
    
    isType(expectedType) {
        return me.type == expectedType
    }
}

// ğŸ”¢ æ•°å€¤ãƒˆãƒ¼ã‚¯ãƒ³å°‚ç”¨Box
box NumberToken from Token<IntegerBox> {
    init { numValue }
    
    NumberToken(value) {
        super("NUMBER", value)
        me.numValue = value
    }
    
    getValue() {
        return me.numValue
    }
}

// â• æ¼”ç®—å­ãƒˆãƒ¼ã‚¯ãƒ³å°‚ç”¨Box
box OperatorToken from Token<StringBox> {
    init { operator, precedence }
    
    OperatorToken(op) {
        super("OPERATOR", op)
        me.operator = op
        
        // æ¼”ç®—å­å„ªå…ˆåº¦è¨­å®š
        if op == "+" || op == "-" {
            me.precedence = 1
        }
        if op == "*" || op == "/" {
            me.precedence = 2
        }
    }
    
    getPrecedence() {
        return me.precedence
    }
}

// ğŸ“ å­—å¥è§£æå™¨Box
box Tokenizer {
    init { input, position, tokens }
    
    Tokenizer(expression) {
        me.input = expression
        me.position = 0
        me.tokens = new ArrayBox()
    }
    
    // æ¬¡ã®æ–‡å­—ã‚’å–å¾—
    peek() {
        if me.position >= me.input.length() {
            return ""
        }
        return me.input.charAt(me.position)
    }
    
    // æ–‡å­—ã‚’æ¶ˆè²»ã—ã¦é€²ã‚€
    advance() {
        me.position = me.position + 1
    }
    
    // ç©ºç™½ã‚’ã‚¹ã‚­ãƒƒãƒ—
    skipWhitespace() {
        loop(me.position < me.input.length() && me.peek() == " ") {
            me.advance()
        }
    }
    
    // æ•°å€¤ã‚’èª­ã¿å–ã‚Š
    readNumber() {
        start = me.position
        
        loop(me.position < me.input.length()) {
            char = me.peek()
            if char >= "0" && char <= "9" {
                me.advance()
            } else {
                break
            }
        }
        
        numberStr = me.input.substring(start, me.position)
        return new NumberToken(numberStr.toInteger())
    }
    
    // ãƒˆãƒ¼ã‚¯ãƒ³åŒ–å®Ÿè¡Œ
    tokenize() {
        loop(me.position < me.input.length()) {
            me.skipWhitespace()
            
            if me.position >= me.input.length() {
                break
            }
            
            char = me.peek()
            
            // æ•°å€¤ã®å ´åˆ
            if char >= "0" && char <= "9" {
                token = me.readNumber()
                me.tokens.push(token)
                DEBUG.trackBox(token, "number_token_" + me.tokens.length())
            }
            // æ¼”ç®—å­ã®å ´åˆ
            else if char == "+" || char == "-" || char == "*" || char == "/" {
                token = new OperatorToken(char)
                me.tokens.push(token)
                me.advance()
                DEBUG.trackBox(token, "operator_token_" + me.tokens.length())
            }
            // æ‹¬å¼§ã®å ´åˆ
            else if char == "(" || char == ")" {
                token = new Token("PAREN", char)
                me.tokens.push(token)
                me.advance()
                DEBUG.trackBox(token, "paren_token_" + me.tokens.length())
            }
            else {
                print("âŒ Unknown character: " + char)
                me.advance()
            }
        }
        
        // çµ‚ç«¯ãƒˆãƒ¼ã‚¯ãƒ³è¿½åŠ 
        eofToken = new Token("EOF", "")
        me.tokens.push(eofToken)
        
        return me.tokens
    }
    
    printTokens() {
        print("ğŸ¯ Tokens:")
        i = 0
        loop(i < me.tokens.length()) {
            token = me.tokens.get(i)
            print("  " + i + ": " + token.toString())
            i = i + 1
        }
    }
}

// ğŸ” æ§‹æ–‡è§£æå™¨Box - å†å¸°ä¸‹é™ãƒ‘ãƒ¼ã‚µãƒ¼
box Parser {
    init { tokens, position }
    
    Parser(tokenList) {
        me.tokens = tokenList
        me.position = 0
    }
    
    // ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    currentToken() {
        if me.position >= me.tokens.length() {
            return new Token("EOF", "")
        }
        return me.tokens.get(me.position)
    }
    
    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¶ˆè²»ã—ã¦é€²ã‚€
    consume() {
        me.position = me.position + 1
    }
    
    // æŒ‡å®šã—ãŸã‚¿ã‚¤ãƒ—ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æœŸå¾…ã—ã¦æ¶ˆè²»
    expect(expectedType) {
        token = me.currentToken()
        if token.isType(expectedType) {
            me.consume()
            return token
        }
        print("âŒ Parse error: Expected " + expectedType + ", got " + token.type)
        return null
    }
    
    // å¼ã®è§£æ (+ ã¨ -)
    parseExpression() {
        DEBUG.traceCall("parseExpression", "", "")
        
        result = me.parseTerm()
        
        loop(true) {
            token = me.currentToken()
            if token.isType("OPERATOR") {
                op = token.value
                if op == "+" || op == "-" {
                    me.consume()
                    right = me.parseTerm()
                    
                    if op == "+" {
                        result = result + right
                    } else {
                        result = result - right
                    }
                    
                    print("ğŸ“Š " + op + " operation: result = " + result)
                } else {
                    break
                }
            } else {
                break
            }
        }
        
        return result
    }
    
    // é …ã®è§£æ (* ã¨ /)
    parseTerm() {
        DEBUG.traceCall("parseTerm", "", "")
        
        result = me.parseFactor()
        
        loop(true) {
            token = me.currentToken()
            if token.isType("OPERATOR") {
                op = token.value
                if op == "*" || op == "/" {
                    me.consume()
                    right = me.parseFactor()
                    
                    if op == "*" {
                        result = result * right
                    } else {
                        if right == 0 {
                            print("âŒ Division by zero!")
                            return 0
                        }
                        result = result / right
                    }
                    
                    print("ğŸ“Š " + op + " operation: result = " + result)
                } else {
                    break
                }
            } else {
                break
            }
        }
        
        return result
    }
    
    // å› å­ã®è§£æ (æ•°å€¤ã¨æ‹¬å¼§)
    parseFactor() {
        DEBUG.traceCall("parseFactor", "", "")
        
        token = me.currentToken()
        
        // æ•°å€¤
        if token.isType("NUMBER") {
            me.consume()
            value = token.value.toInteger()
            print("ğŸ”¢ Number: " + value)
            return value
        }
        // æ‹¬å¼§
        else if token.isType("PAREN") && token.value == "(" {
            me.consume()  // consume '('
            result = me.parseExpression()
            me.expect("PAREN")  // expect ')'
            return result
        }
        // ã‚¨ãƒ©ãƒ¼
        else {
            print("âŒ Parse error: Unexpected token " + token.toString())
            return 0
        }
    }
    
    // æ§‹æ–‡è§£æå®Ÿè¡Œ
    parse() {
        print("ğŸš€ Starting parse...")
        result = me.parseExpression()
        
        // æœ€å¾Œã«EOFãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        if !me.currentToken().isType("EOF") {
            print("âš ï¸  Warning: Extra tokens after expression")
        }
        
        return result
    }
}

// ğŸ§® ãƒ¡ã‚¤ãƒ³è¨ˆç®—æ©ŸBox
box Calculator {
    init { name }
    
    Calculator() {
        me.name = "Nyash Calculator"
    }
    
    // å¼ã‚’è©•ä¾¡
    evaluate(expression) {
        print("\nğŸ“ Evaluating: " + expression)
        
        // Step 1: ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
        tokenizer = new Tokenizer(expression)
        DEBUG.trackBox(tokenizer, "main_tokenizer")
        
        tokens = tokenizer.tokenize()
        tokenizer.printTokens()
        
        // Step 2: æ§‹æ–‡è§£æãƒ»è©•ä¾¡
        parser = new Parser(tokens)
        DEBUG.trackBox(parser, "main_parser")
        
        result = parser.parse()
        
        print("âœ… Result: " + result)
        return result
    }
}

// ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
print("ğŸ¯ Testing Nyash Calculator...")

calc = new Calculator()
DEBUG.trackBox(calc, "main_calculator")

// ãƒ†ã‚¹ãƒˆå¼
testExpressions = new ArrayBox()
testExpressions.push("2 + 3")
testExpressions.push("5 * 4")  
testExpressions.push("10 - 6")
testExpressions.push("15 / 3")
testExpressions.push("2 + 3 * 4")
testExpressions.push("(2 + 3) * 4")

// ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
i = 0
loop(i < testExpressions.length()) {
    expression = testExpressions.get(i)
    calc.evaluate(expression)
    i = i + 1
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
print("\nğŸ“Š === Debug Report ===")
print(DEBUG.memoryReport())
print(DEBUG.showCallStack())

print("\nğŸ‰ Calculator app completed!")