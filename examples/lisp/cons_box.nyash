// ğŸ“¦ ConsBox - LISPã®cons cellå®Ÿè£…
// ãƒšã‚¢ï¼ˆcar, cdrï¼‰ã‚’è¡¨ç¾ã™ã‚‹åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

box ConsBox {
    car    // æœ€åˆã®è¦ç´ 
    cdr    // æ®‹ã‚Šã®è¦ç´ ï¼ˆé€šå¸¸ã¯åˆ¥ã®ConsBoxã‹NullBoxï¼‰
    
    init {
        car, cdr
    }
    
    // åŸºæœ¬ã‚¢ã‚¯ã‚»ã‚µ
    func getCar() {
        return me.car
    }
    
    func getCdr() {
        return me.cdr
    }
    
    func setCar(value) {
        me.car = value
    }
    
    func setCdr(value) {
        me.cdr = value
    }
    
    // ãƒªã‚¹ãƒˆã‹ã©ã†ã‹ã®åˆ¤å®š
    func isList() {
        // cdrãŒNullBoxãªã‚‰ãƒªã‚¹ãƒˆã®çµ‚ç«¯
        if (NullBox.check_null(me.cdr)) {
            return true
        }
        // cdrãŒConsBoxãªã‚‰å†å¸°çš„ã«ãƒã‚§ãƒƒã‚¯
        // TODO: å‹ãƒã‚§ãƒƒã‚¯ã®åˆ¥ã®æ–¹æ³•ãŒå¿…è¦
        // æš«å®šçš„ã«trueã‚’è¿”ã™
        return true
        // ãã‚Œä»¥å¤–ã¯ãƒ‰ãƒƒãƒˆå¯¾
        return false
    }
    
    // ãƒªã‚¹ãƒˆã®é•·ã•ã‚’å–å¾—
    func length() {
        if (not me.isList()) {
            return -1  // ãƒªã‚¹ãƒˆã§ãªã„å ´åˆã¯-1
        }
        
        count = 0
        current = me
        loop(not NullBox.check_null(current)) {
            count = count + 1
            current = current.getCdr()
        }
        return count
    }
    
    // nç•ªç›®ã®è¦ç´ ã‚’å–å¾—ï¼ˆ0ãƒ™ãƒ¼ã‚¹ï¼‰
    func nth(n) {
        if (n < 0) {
            return new NullBox()
        }
        
        current = me
        i = 0
        loop(i < n) {
            if (NullBox.check_null(current)) {
                return new NullBox()
            }
            current = current.getCdr()
            i = i + 1
        }
        
        if (NullBox.check_null(current)) {
            return new NullBox()
        }
        return current.getCar()
    }
    
    // ãƒªã‚¹ãƒˆã‚’é…åˆ—ã«å¤‰æ›
    func toArray() {
        result = new ArrayBox()
        current = me
        
        loop(not NullBox.check_null(current)) {
            result.push(current.getCar())
            cdr = current.getCdr()
            
            // ãƒ‰ãƒƒãƒˆå¯¾ã®å ´åˆ
            // TODO: å‹ãƒã‚§ãƒƒã‚¯ã®åˆ¥ã®æ–¹æ³•ãŒå¿…è¦
            // æš«å®šçš„ã«ã‚¹ã‚­ãƒƒãƒ—
            
            current = cdr
        }
        
        return result
    }
    
    // æ–‡å­—åˆ—è¡¨ç¾
    func toString() {
        // ç©ºãƒªã‚¹ãƒˆ
        if (NullBox.check_null(me.car) and NullBox.check_null(me.cdr)) {
            return "()"
        }
        
        result = "("
        current = me
        first = true
        
        loop(not NullBox.check_null(current)) {
            if (not first) {
                result = result + " "
            }
            first = false
            
            // carã®è¡¨ç¤º
            car = current.getCar()
            if (NullBox.check_null(car)) {
                result = result + "nil"
            } else {
                result = result + car.toString()
            }
            
            // cdrã®ç¢ºèª
            cdr = current.getCdr()
            if (NullBox.check_null(cdr)) {
                break
            }
            
            // ãƒ‰ãƒƒãƒˆå¯¾ã®å ´åˆ
            // TODO: å‹ãƒã‚§ãƒƒã‚¯ã®åˆ¥ã®æ–¹æ³•ãŒå¿…è¦
            // æš«å®šçš„ã«ã‚¹ã‚­ãƒƒãƒ—
            
            current = cdr
        }
        
        result = result + ")"
        return result
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ã®è©³ç´°è¡¨ç¤º
    func debugPrint() {
        print("ConsBox {")
        print("  car: " + me.car.toString())
        print("  cdr: " + me.cdr.toString())
        print("  isList: " + me.isList())
        if (me.isList()) {
            print("  length: " + me.length())
        }
        print("}")
    }
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šé…åˆ—ã‹ã‚‰ãƒªã‚¹ãƒˆã‚’ä½œæˆ
function arrayToList(arr) {
    if (arr.length() == 0) {
        return new NullBox()
    }
    
    // é€†é †ã«æ§‹ç¯‰
    result = new NullBox()
    i = arr.length() - 1
    loop(i >= 0) {
        result = new ConsBox(arr.get(i), result)
        i = i - 1
    }
    
    return result
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šå¯å¤‰é•·å¼•æ•°ã§ãƒªã‚¹ãƒˆã‚’ä½œæˆ
function list() {
    // TODO: å¯å¤‰é•·å¼•æ•°ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦
    // ç¾åœ¨ã¯å›ºå®šæ•°ã®å¼•æ•°ã§ã®å®Ÿè£…ä¾‹
    return new NullBox()
}

// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
print("ğŸ¯ === ConsBox Test ===")

// åŸºæœ¬çš„ãªãƒšã‚¢
print("ğŸ“¦ åŸºæœ¬çš„ãªãƒšã‚¢ (1 . 2):")
pair = new ConsBox(new IntegerBox(1), new IntegerBox(2))
print(pair.toString())
pair.debugPrint()

// ãƒªã‚¹ãƒˆ (1 2 3)
print("\nğŸ“‹ ãƒªã‚¹ãƒˆ (1 2 3):")
list123 = new ConsBox(
    new IntegerBox(1),
    new ConsBox(
        new IntegerBox(2),
        new ConsBox(
            new IntegerBox(3),
            new NullBox()
        )
    )
)
print(list123.toString())
print("Length: " + list123.length())
print("2nd element: " + list123.nth(1).toString())

// é…åˆ—ã‹ã‚‰ãƒªã‚¹ãƒˆã‚’ä½œæˆ
print("\nğŸ”„ é…åˆ—ã‹ã‚‰ãƒªã‚¹ãƒˆä½œæˆ:")
arr = new ArrayBox()
arr.push(new StringBox("hello"))
arr.push(new StringBox("world"))
arr.push(new IntegerBox(42))
listFromArray = arrayToList(arr)
print(listFromArray.toString())

// ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆ ((1 2) (3 4))
print("\nğŸ¯ ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆ:")
innerList1 = new ConsBox(
    new IntegerBox(1),
    new ConsBox(new IntegerBox(2), new NullBox())
)
innerList2 = new ConsBox(
    new IntegerBox(3),
    new ConsBox(new IntegerBox(4), new NullBox())
)
nestedList = new ConsBox(
    innerList1,
    new ConsBox(innerList2, new NullBox())
)
print(nestedList.toString())

print("\nâœ… ConsBox implementation completed!")