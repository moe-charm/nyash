// ğŸ“¦ ConsBox - LISPã®cons cellå®Ÿè£… v3
// ğŸ‰ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã‚µãƒãƒ¼ãƒˆç‰ˆï¼

// NilBox - nullå€¤ã®ä»£æ›¿å®Ÿè£…
box NilBox {
    init {}
    
    isNil() { return true }
    toString() { return "nil" }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªnilå€¤
NIL = new NilBox()

// nilåˆ¤å®šé–¢æ•°
function isNil(value) {
    if value == 0 { return true }
    if value == NIL { return true }
    // NilBoxã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå‹å®‰å…¨ï¼‰
    // InstanceBoxã®ã¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    return false  // ä»–ã®å€¤ã¯nilã§ã¯ãªã„
}

box ConsBox {
    car
    cdr
    
    init { car, cdr }
    
    // ğŸ‰ NEW: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°å¯¾å¿œï¼
    ConsBox(a, d) {
        me.car = a
        me.cdr = d
    }
    
    // å¼•æ•°ãªã—ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    ConsBox() {
        me.car = NIL
        me.cdr = NIL
    }
    
    getCar() { return me.car }
    getCdr() { return me.cdr }
    setCar(value) { me.car = value }
    setCdr(value) { me.cdr = value }
    
    // ãƒªã‚¹ãƒˆå½¢å¼ã®æ–‡å­—åˆ—è¡¨ç¾
    toString() {
        return me.toStringHelper(true)
    }
    
    toStringHelper(isFirst) {
        result = ""
        if isFirst { result = "(" }
        
        // caréƒ¨åˆ†ã®å‡¦ç†
        if isNil(me.car) {
            result = result + "nil"
        } else {
            result = result + me.car
        }
        
        // cdréƒ¨åˆ†ã®å‡¦ç†
        if isNil(me.cdr) {
            result = result + ")"
        } else {
            // ãƒ‰ãƒƒãƒˆå¯¾ã¨ã—ã¦è¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
            result = result + " . " + me.cdr + ")"
        }
        
        return result
    }
}

// ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
function cons(car, cdr) {
    return new ConsBox(car, cdr)
}

// ãƒªã‚¹ãƒˆä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
function list() {
    // å¼•æ•°ãªã—ã®å ´åˆã¯ç©ºãƒªã‚¹ãƒˆ
    return NIL
}

function list1(a) {
    return new ConsBox(a, NIL)
}

function list2(a, b) {
    return new ConsBox(a, new ConsBox(b, NIL))
}

function list3(a, b, c) {
    return new ConsBox(a, new ConsBox(b, new ConsBox(c, NIL)))
}

// car/cdr ã‚¢ã‚¯ã‚»ã‚µé–¢æ•°
function car(pair) {
    if isNil(pair) { return NIL }
    return pair.getCar()
}

function cdr(pair) {
    if isNil(pair) { return NIL }
    return pair.getCdr()
}

// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
print("ğŸ¯ === ConsBox v3 Test (Constructor Args!) ===")
print("")

// åŸºæœ¬çš„ãªãƒšã‚¢ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ä½¿ç”¨ï¼‰
print("1. Basic cons cell with constructor args:")
pair1 = new ConsBox(1, 2)
print("   new ConsBox(1, 2) = " + pair1.toString())

// ãƒªã‚¹ãƒˆä½œæˆ
print("")
print("2. List creation:")
list_a = list1("hello")
print("   (list 'hello') = " + list_a.toString())

list_b = list2(10, 20)
print("   (list 10 20) = " + list_b.toString())

list_c = list3("a", "b", "c")
print("   (list 'a' 'b' 'c') = " + list_c.toString())

// car/cdræ“ä½œ
print("")
print("3. car/cdr operations:")
test = new ConsBox(42, "world")
print("   test = " + test.toString())
print("   (car test) = " + car(test))
print("   (cdr test) = " + cdr(test))

// ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆ
print("")
print("4. Nested lists:")
inner = new ConsBox(1, new ConsBox(2, NIL))
outer = new ConsBox(inner, new ConsBox(3, NIL))
print("   ((1 2) 3) = " + outer.toString())

// ç©ºãƒªã‚¹ãƒˆ
print("")
print("5. Empty list:")
empty = NIL
print("   '() = " + empty.toString())

// nilè¦ç´ ã‚’å«ã‚€ãƒªã‚¹ãƒˆ
print("")
print("6. List with nil:")
list_with_nil = new ConsBox(1, new ConsBox(NIL, new ConsBox(3, NIL)))
print("   (1 nil 3) = " + list_with_nil.toString())

print("")
print("âœ… ConsBox v3 tests completed!")