// ğŸ“¦ ConsBox - LISPã®cons cellå®Ÿè£… v4
// ğŸ‰ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã‚µãƒãƒ¼ãƒˆç‰ˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰

// NilBox - nullå€¤ã®ä»£æ›¿å®Ÿè£…
box NilBox {
    init {}
    
    isNil() { return true }
    toString() { return "nil" }
    
    // ãƒªã‚¹ãƒˆçµ‚ç«¯ãƒã‚§ãƒƒã‚¯ç”¨
    isNilBox() { return true }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªnilå€¤
NIL = new NilBox()

box ConsBox {
    car
    cdr
    
    init { car, cdr }
    
    // ğŸ‰ NEW: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°å¯¾å¿œï¼
    ConsBox(a, d) {
        me.car = a
        me.cdr = d
    }
    
    // å¼•æ•°ãªã—ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    ConsBox() {
        me.car = NIL
        me.cdr = NIL
    }
    
    getCar() { return me.car }
    getCdr() { return me.cdr }
    setCar(value) { me.car = value }
    setCdr(value) { me.cdr = value }
    
    // ConsBoxã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ¡ã‚½ãƒƒãƒ‰
    isConsBox() { return true }
    
    // é©åˆ‡ãªãƒªã‚¹ãƒˆå½¢å¼ã®æ–‡å­—åˆ—è¡¨ç¾
    toString() {
        // ãƒªã‚¹ãƒˆã‹ãƒ‰ãƒƒãƒˆå¯¾ã‹ã‚’åˆ¤å®šã—ã¦é©åˆ‡ã«è¡¨ç¤º
        if me.isList() {
            return me.toListString()
        } else {
            return "(" + me.car + " . " + me.cdr + ")"
        }
    }
    
    // ãƒªã‚¹ãƒˆã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆcdrãŒnilçµ‚ç«¯ï¼‰
    isList() {
        current = me
        loop(true) {
            // cdrãŒNILãªã‚‰ãƒªã‚¹ãƒˆ
            if current.cdr == NIL {
                return true
            }
            // cdrãŒConsBoxã§ãªã‘ã‚Œã°ãƒ‰ãƒƒãƒˆå¯¾
            if not (current.cdr.isConsBox and current.cdr.isConsBox()) {
                return false
            }
            current = current.cdr
        }
    }
    
    // ãƒªã‚¹ãƒˆå½¢å¼ã®æ–‡å­—åˆ—ç”Ÿæˆ
    toListString() {
        result = "("
        current = me
        first = true
        
        loop(current != NIL) {
            if not first {
                result = result + " "
            }
            first = false
            
            // carã®å†…å®¹ã‚’è¿½åŠ 
            result = result + current.car
            
            // æ¬¡ã®è¦ç´ ã¸
            if current.cdr == NIL {
                break
            }
            current = current.cdr
        }
        
        result = result + ")"
        return result
    }
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function cons(car, cdr) {
    return new ConsBox(car, cdr)
}

function list1(a) {
    return new ConsBox(a, NIL)
}

function list2(a, b) {
    return new ConsBox(a, new ConsBox(b, NIL))
}

function list3(a, b, c) {
    return new ConsBox(a, new ConsBox(b, new ConsBox(c, NIL)))
}

function car(pair) {
    if pair == NIL { return NIL }
    return pair.getCar()
}

function cdr(pair) {
    if pair == NIL { return NIL }
    return pair.getCdr()
}

// ãƒªã‚¹ãƒˆæ“ä½œé–¢æ•°
function append(list1, list2) {
    if list1 == NIL { return list2 }
    return new ConsBox(car(list1), append(cdr(list1), list2))
}

function length(lst) {
    count = 0
    current = lst
    loop(current != NIL) {
        count = count + 1
        current = cdr(current)
    }
    return count
}

// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
print("ğŸ¯ === ConsBox v4 Test (Improved!) ===")
print("")

// åŸºæœ¬çš„ãªãƒšã‚¢
print("1. Basic cons cells:")
pair1 = new ConsBox(1, 2)
print("   (cons 1 2) = " + pair1.toString())
pair2 = cons("a", "b")
print("   (cons 'a' 'b') = " + pair2.toString())

// ãƒªã‚¹ãƒˆä½œæˆ
print("")
print("2. List creation:")
list_a = list1("hello")
print("   (list 'hello') = " + list_a.toString())

list_b = list2(10, 20)
print("   (list 10 20) = " + list_b.toString())

list_c = list3("a", "b", "c")
print("   (list 'a' 'b' 'c') = " + list_c.toString())

// car/cdræ“ä½œ
print("")
print("3. car/cdr operations:")
test = list3(1, 2, 3)
print("   test = " + test.toString())
print("   (car test) = " + car(test))
print("   (cdr test) = " + cdr(test).toString())
print("   (car (cdr test)) = " + car(cdr(test)))

// ãƒªã‚¹ãƒˆæ“ä½œ
print("")
print("4. List operations:")
lst1 = list3("x", "y", "z")
lst2 = list2("a", "b")
print("   lst1 = " + lst1.toString())
print("   lst2 = " + lst2.toString())
print("   (length lst1) = " + length(lst1))
print("   (append lst1 lst2) = " + append(lst1, lst2).toString())

// ãƒã‚¹ãƒˆã—ãŸãƒªã‚¹ãƒˆ
print("")
print("5. Nested lists:")
inner1 = list2(1, 2)
inner2 = list2(3, 4)
nested = list3(inner1, inner2, 5)
print("   nested = " + nested.toString())

// ç©ºãƒªã‚¹ãƒˆ
print("")
print("6. Empty list:")
empty = NIL
print("   '() = " + empty.toString())

print("")
print("âœ… ConsBox v4 tests completed!")