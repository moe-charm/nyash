// ğŸ§¬ Conway's Game of Life - Canvasç‰ˆè¦–è¦šåŒ–
// ã‚»ãƒ«ãƒ©ãƒ¼ã‚ªãƒ¼ãƒˆãƒãƒˆãƒ³ã®ç¾ã—ã„å¯è¦–åŒ–

print("ğŸ§¬ === Conway's Game of Life - Canvas Edition ===")

DEBUG = new DebugBox()
DEBUG.startTracking()

// ğŸ”¬ ã‚»ãƒ«Box - å„ã‚»ãƒ«ãŒç‹¬ç«‹ã—ãŸç”Ÿå‘½ä½“
box CellBox {
    init { alive, nextState, x, y }
    
    CellBox(posX, posY, initialState) {
        me.alive = initialState
        me.nextState = false
        me.x = posX
        me.y = posY
    }
    
    setNextState(state) {
        me.nextState = state
    }
    
    update() {
        me.alive = me.nextState
    }
    
    isAlive() {
        return me.alive
    }
    
    draw(canvas, cellSize) {
        color = "black"
        if me.alive {
            color = "lime"
        }
        
        canvas.setFillStyle(color)
        canvas.fillRect(me.x * cellSize, me.y * cellSize, cellSize, cellSize)
        
        // ã‚°ãƒªãƒƒãƒ‰ç·š
        canvas.setStrokeStyle("gray")
        canvas.strokeRect(me.x * cellSize, me.y * cellSize, cellSize, cellSize)
    }
}

// ğŸŒ Game of Lifeä¸–ç•ŒBox
box GameOfLifeBox {
    init { grid, width, height, canvas, cellSize, generation }
    
    GameOfLifeBox(canvasId, gridWidth, gridHeight, pixelCellSize) {
        me.width = gridWidth
        me.height = gridHeight
        me.cellSize = pixelCellSize
        me.generation = 0
        
        // CanvasåˆæœŸåŒ–
        canvasWidth = gridWidth * pixelCellSize
        canvasHeight = gridHeight * pixelCellSize
        me.canvas = new WebCanvasBox(canvasId, canvasWidth, canvasHeight)
        
        // ã‚°ãƒªãƒƒãƒ‰åˆæœŸåŒ–
        me.grid = new ArrayBox()
        y = 0
        loop (y < me.height) {
            row = new ArrayBox()
            x = 0
            loop (x < me.width) {
                cell = new CellBox(x, y, false)
                row.add(cell)
                x = x + 1
            }
            me.grid.add(row)
            y = y + 1
        }
        
        DEBUG.trackBox(me, "GameOfLifeWorld")
    }
    
    // æŒ‡å®šä½ç½®ã®ã‚»ãƒ«ã‚’å–å¾—
    getCell(x, y) {
        if x >= 0 and x < me.width and y >= 0 and y < me.height {
            row = me.grid.get(y)
            return row.get(x)
        }
        return new CellBox(-1, -1, false)  // å¢ƒç•Œå¤–ã¯æ­»ã‚“ã ã‚»ãƒ«
    }
    
    // è¿‘å‚ã®ç”Ÿãã¦ã„ã‚‹ã‚»ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    countLiveNeighbors(x, y) {
        count = 0
        
        // 8è¿‘å‚ã‚’ãƒã‚§ãƒƒã‚¯
        dy = -1
        loop (dy <= 1) {
            dx = -1
            loop (dx <= 1) {
                if not (dx == 0 and dy == 0) {  // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
                    neighbor = me.getCell(x + dx, y + dy)
                    if neighbor.isAlive() {
                        count = count + 1
                    }
                }
                dx = dx + 1
            }
            dy = dy + 1
        }
        
        return count
    }
    
    // Conway's Game of Lifeãƒ«ãƒ¼ãƒ«ã®é©ç”¨
    applyRules() {
        // æ¬¡ä¸–ä»£ã®çŠ¶æ…‹ã‚’è¨ˆç®—
        y = 0
        loop (y < me.height) {
            x = 0
            loop (x < me.width) {
                cell = me.getCell(x, y)
                liveNeighbors = me.countLiveNeighbors(x, y)
                
                newState = false
                
                if cell.isAlive() {
                    // ç”Ÿãã¦ã„ã‚‹ã‚»ãƒ«ã®ãƒ«ãƒ¼ãƒ«
                    if liveNeighbors == 2 or liveNeighbors == 3 {
                        newState = true  // ç”Ÿå­˜
                    }
                    // ãã‚Œä»¥å¤–ã¯æ­»æ»…ï¼ˆéç–ãƒ»éå¯†ï¼‰
                } else {
                    // æ­»ã‚“ã§ã„ã‚‹ã‚»ãƒ«ã®ãƒ«ãƒ¼ãƒ«
                    if liveNeighbors == 3 {
                        newState = true  // èª•ç”Ÿ
                    }
                }
                
                cell.setNextState(newState)
                x = x + 1
            }
            y = y + 1
        }
        
        // çŠ¶æ…‹ã‚’ä¸€æ–‰æ›´æ–°
        y = 0
        loop (y < me.height) {
            x = 0
            loop (x < me.width) {
                cell = me.getCell(x, y)
                cell.update()
                x = x + 1
            }
            y = y + 1
        }
        
        me.generation = me.generation + 1
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š
    setPattern(pattern) {
        if pattern == "glider" {
            // ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
            me.getCell(1, 0).alive = true
            me.getCell(2, 1).alive = true
            me.getCell(0, 2).alive = true
            me.getCell(1, 2).alive = true
            me.getCell(2, 2).alive = true
        }
        
        if pattern == "blinker" {
            // ç‚¹æ»…ãƒ‘ã‚¿ãƒ¼ãƒ³
            centerX = me.width / 2
            centerY = me.height / 2
            me.getCell(centerX - 1, centerY).alive = true
            me.getCell(centerX, centerY).alive = true
            me.getCell(centerX + 1, centerY).alive = true
        }
        
        if pattern == "random" {
            // ãƒ©ãƒ³ãƒ€ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³
            random = new RandomBox()
            y = 0
            loop (y < me.height) {
                x = 0
                loop (x < me.width) {
                    if random.float() < 0.3 {  // 30%ã®ç¢ºç‡ã§ç”Ÿå­˜
                        me.getCell(x, y).alive = true
                    }
                    x = x + 1
                }
                y = y + 1
            }
        }
    }
    
    // æç”»
    render() {
        // èƒŒæ™¯ã‚¯ãƒªã‚¢
        me.canvas.setFillStyle("white")
        me.canvas.fillRect(0, 0, me.canvas.width, me.canvas.height)
        
        // å…¨ã‚»ãƒ«æç”»
        y = 0
        loop (y < me.height) {
            x = 0
            loop (x < me.width) {
                cell = me.getCell(x, y)
                cell.draw(me.canvas, me.cellSize)
                x = x + 1
            }
            y = y + 1
        }
        
        // æƒ…å ±è¡¨ç¤º
        me.canvas.setFillStyle("blue")
        me.canvas.fillText("Generation: " + me.generation, 10, 20)
        me.canvas.fillText("Conway's Game of Life", 10, 40)
    }
    
    // ç”Ÿãã¦ã„ã‚‹ã‚»ãƒ«ã®ç·æ•°
    countAliveCells() {
        count = 0
        y = 0
        loop (y < me.height) {
            x = 0
            loop (x < me.width) {
                if me.getCell(x, y).isAlive() {
                    count = count + 1
                }
                x = x + 1
            }
            y = y + 1
        }
        return count
    }
}

// ğŸš€ Game of Lifeé–‹å§‹ï¼
print("Creating Conway's Game of Life world...")
game = new GameOfLifeBox("life-canvas", 40, 30, 10)

// ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š
print("ğŸ§¬ Setting up initial patterns...")
game.setPattern("random")

// ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
print("ğŸŒ± Running life simulation...")
generation = 0
loop (generation < 50) {
    game.render()
    aliveCount = game.countAliveCells()
    
    if generation % 10 == 0 {
        print("Generation " + generation + ": " + aliveCount + " cells alive")
    }
    
    game.applyRules()
    generation = generation + 1
}

// æœ€çµ‚çµ±è¨ˆ
finalAlive = game.countAliveCells()
print("ğŸ Simulation complete!")
print("Final generation: " + game.generation)
print("Final alive cells: " + finalAlive)
print(DEBUG.memoryReport())

print("âœ¨ Conway's Game of Life - Everything is Box!")
print("ğŸ”¬ Each cell is an independent CellBox")
print("ğŸŒ The world itself is a GameOfLifeBox")
print("ğŸ¨ Beautiful visualization through WebCanvasBox")