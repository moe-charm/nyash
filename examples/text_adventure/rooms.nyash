// Text Adventure Game - Rooms Module
// ãƒ«ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…

include "text_adventure/items.nyash"

// åŸºæœ¬ãƒ«ãƒ¼ãƒ Box
box Room {
    init { name, description, items, exits, visited, locked }
    
    Room(name, description) {
        me.name = name
        me.description = description
        me.items = new MapBox()
        me.exits = new MapBox()
        me.visited = false
        me.locked = false
    }
    
    // ãƒ«ãƒ¼ãƒ ã®è¡¨ç¤º
    look() {
        result = ""
        if me.visited {
            result = me.name + "\n"
        } else {
            result = me.name + " (First time here!)\n"
            me.visited = true
        }
        
        result = result + me.description + "\n"
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã®è¡¨ç¤º
        if me.items.size() > 0 {
            result = result + "\nItems here:\n"
            // MapBoxã®ã‚­ãƒ¼ã‚’åå¾©å‡¦ç†
            keys = me.items.keys()
            i = 0
            loop(i < keys.size()) {
                itemName = keys.get(i)
                item = me.items.get(itemName)
                itemDisplay = item.display()
                result = result + "- " + itemDisplay + "\n"
                i = i + 1
            }
        }
        
        // å‡ºå£ã®è¡¨ç¤º
        if me.exits.size() > 0 {
            result = result + "\nExits: "
            exitKeys = me.exits.keys()
            i = 0
            loop(i < exitKeys.size()) {
                direction = exitKeys.get(i)
                if i > 0 {
                    result = result + ", "
                }
                result = result + direction
                i = i + 1
            }
            result = result + "\n"
        }
        
        return result
    }
    
    // ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
    addItem(item) {
        itemName = item.name
        me.items.put(itemName, item)
    }
    
    // ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ï¼ˆå‰Šé™¤ï¼‰
    takeItem(itemName) {
        if me.items.has(itemName) {
            item = me.items.get(itemName)
            me.items.remove(itemName)
            return item
        }
        return null
    }
    
    // ã‚¢ã‚¤ãƒ†ãƒ ã®å­˜åœ¨ç¢ºèª
    hasItem(itemName) {
        return me.items.has(itemName)
    }
    
    // å‡ºå£ã‚’è¿½åŠ 
    addExit(direction, targetRoom) {
        me.exits.put(direction, targetRoom)
    }
    
    // ç§»å‹•ã‚’è©¦è¡Œ
    move(direction) {
        if me.exits.has(direction) {
            targetRoom = me.exits.get(direction)
            isLocked = targetRoom.locked
            if isLocked {
                return null  // éµãŒã‹ã‹ã£ã¦ã„ã‚‹
            }
            return targetRoom
        }
        return null  // å‡ºå£ãŒãªã„
    }
    
    // ãƒ«ãƒ¼ãƒ ã‚’ãƒ­ãƒƒã‚¯/ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
    lock() {
        me.locked = true
    }
    
    unlock() {
        me.locked = false
    }
    
    isLocked() {
        return me.locked
    }
}

// ç‰¹åˆ¥ãªãƒ«ãƒ¼ãƒ ï¼šå®ç‰©åº«
box TreasureRoom {
    init { name, description, items, exits, visited, locked, treasure }
    
    TreasureRoom(name, description, treasureItem) {
        me.name = name
        me.description = description
        me.items = new MapBox()
        me.exits = new MapBox()
        me.visited = false
        me.locked = true  // å®ç‰©åº«ã¯æœ€åˆãƒ­ãƒƒã‚¯
        me.treasure = treasureItem
        
        // å®ç‰©ã‚’é…ç½®
        me.addItem(me.treasure)
    }
    
    // åŸºæœ¬Roomãƒ¡ã‚½ãƒƒãƒ‰ã‚’å†å®Ÿè£…
    look() {
        result = ""
        if me.visited {
            result = me.name + " âœ¨\n"
        } else {
            result = me.name + " âœ¨ (First time here!)\n"
            me.visited = true
        }
        
        result = result + me.description + "\n"
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã®è¡¨ç¤ºï¼ˆç‰¹åˆ¥æ¼”å‡ºï¼‰
        if me.items.size() > 0 {
            result = result + "\nğŸ’° Treasures here:\n"
            keys = me.items.keys()
            i = 0
            loop(i < keys.size()) {
                itemName = keys.get(i)
                item = me.items.get(itemName)
                itemDisplay = item.display()
                result = result + "- âœ¨ " + itemDisplay + " âœ¨\n"
                i = i + 1
            }
        }
        
        // å‡ºå£ã®è¡¨ç¤º
        if me.exits.size() > 0 {
            result = result + "\nExits: "
            exitKeys = me.exits.keys()
            i = 0
            loop(i < exitKeys.size()) {
                direction = exitKeys.get(i)
                if i > 0 {
                    result = result + ", "
                }
                result = result + direction
                i = i + 1
            }
            result = result + "\n"
        }
        
        return result
    }
    
    addItem(item) {
        me.items.put(item.name, item)
    }
    
    takeItem(itemName) {
        if me.items.has(itemName) {
            item = me.items.get(itemName)
            me.items.remove(itemName)
            return item
        }
        return null
    }
    
    hasItem(itemName) {
        return me.items.has(itemName)
    }
    
    addExit(direction, targetRoom) {
        me.exits.put(direction, targetRoom)
    }
    
    move(direction) {
        if me.exits.has(direction) {
            targetRoom = me.exits.get(direction)
            isLocked = targetRoom.locked
            if isLocked {
                return null
            }
            return targetRoom
        }
        return null
    }
    
    lock() {
        me.locked = true
    }
    
    unlock() {
        me.locked = false
    }
    
    isLocked() {
        return me.locked
    }
}

// ãƒ¯ãƒ¼ãƒ«ãƒ‰ä½œæˆé–¢æ•°
function createWorld() {
    // ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
    sword = createSword()
    potion = createPotion()
    treasureKey = createKey("treasure_room")
    treasure = createTreasure()
    
    // ãƒ«ãƒ¼ãƒ ä½œæˆ
    entrance = new Room("Entrance Hall", "A grand entrance with marble columns. Light streams in from above.")
    corridor = new Room("Long Corridor", "A dimly lit corridor with ancient tapestries on the walls.")
    armory = new Room("Old Armory", "A dusty armory with weapon racks. Some items remain.")
    treasureRoom = new TreasureRoom("Treasure Chamber", "A magnificent chamber filled with golden light.", treasure)
    
    // ã‚¢ã‚¤ãƒ†ãƒ é…ç½®
    armory.addItem(sword)
    corridor.addItem(potion)
    entrance.addItem(treasureKey)
    
    // å‡ºå£è¨­å®šï¼ˆåŒæ–¹å‘ï¼‰
    entrance.addExit("north", corridor)
    corridor.addExit("south", entrance)
    corridor.addExit("east", armory)
    armory.addExit("west", corridor)
    corridor.addExit("west", treasureRoom)
    treasureRoom.addExit("east", corridor)
    
    return entrance  // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
}

print("ğŸ° Rooms module loaded successfully!")