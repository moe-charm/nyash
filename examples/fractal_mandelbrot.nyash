// ğŸ“Š ãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­é›†åˆãƒ•ãƒ©ã‚¯ã‚¿ãƒ« - MathBoxã®æ•°å­¦çš„ç¾ã—ã•
// WebCanvasBox ã§è¤‡ç´ æ•°è¨ˆç®—ã®è¦–è¦šåŒ–

print("ğŸ“Š === Mandelbrot Fractal Generator ===")

// ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ 
DEBUG = new DebugBox()
DEBUG.startTracking()

// ğŸ”¢ è¤‡ç´ æ•°Box - æ•°å­¦çš„è¨ˆç®—ã‚’BoxåŒ–
box ComplexBox {
    init { real, imaginary }
    
    ComplexBox(r, i) {
        me.real = r
        me.imaginary = i
    }
    
    // è¤‡ç´ æ•°ã®ä¹—ç®— z * z
    multiply(other) {
        newReal = me.real * other.real - me.imaginary * other.imaginary
        newImag = me.real * other.imaginary + me.imaginary * other.real
        return new ComplexBox(newReal, newImag)
    }
    
    // è¤‡ç´ æ•°ã®åŠ ç®— z + c
    add(other) {
        return new ComplexBox(me.real + other.real, me.imaginary + other.imaginary)
    }
    
    // çµ¶å¯¾å€¤ã®2ä¹—ï¼ˆç™ºæ•£åˆ¤å®šç”¨ï¼‰
    magnitudeSquared() {
        return me.real * me.real + me.imaginary * me.imaginary
    }
}

// ğŸ¨ ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«æç”»Box
box MandelbrotBox {
    init { canvas, width, height, maxIterations, zoom, centerX, centerY }
    
    MandelbrotBox(canvasId, w, h) {
        me.canvas = new WebCanvasBox(canvasId, w, h)
        me.width = w
        me.height = h
        me.maxIterations = 50
        me.zoom = 1.0
        me.centerX = -0.5  // ãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­é›†åˆã®ä¸­å¿ƒ
        me.centerY = 0.0
        
        DEBUG.trackBox(me, "MandelbrotGenerator")
    }
    
    // ç‚¹ãŒãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­é›†åˆã«å±ã™ã‚‹ã‹åˆ¤å®š
    mandelbrotIterations(c) {
        z = new ComplexBox(0.0, 0.0)  // z0 = 0
        
        iteration = 0
        loop (iteration < me.maxIterations) {
            // z = z^2 + c ã®åå¾©è¨ˆç®—
            z = z.multiply(z).add(c)
            
            // ç™ºæ•£åˆ¤å®šï¼ˆ|z| > 2ï¼‰
            if z.magnitudeSquared() > 4.0 {
                return iteration
            }
            
            iteration = iteration + 1
        }
        
        return me.maxIterations  // åæŸï¼ˆãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­é›†åˆå†…ï¼‰
    }
    
    // åå¾©å›æ•°ã‚’è‰²ã«å¤‰æ›
    getColor(iterations) {
        if iterations == me.maxIterations {
            return "black"  // ãƒãƒ³ãƒ‡ãƒ«ãƒ–ãƒ­é›†åˆå†…
        }
        
        // ã‚«ãƒ©ãƒ•ãƒ«ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        ratio = iterations / me.maxIterations
        
        if ratio < 0.25 {
            return "blue"
        } else {
            if ratio < 0.5 {
                return "cyan"
            } else {
                if ratio < 0.75 {
                    return "yellow"
                } else {
                    return "red"
                }
            }
        }
    }
    
    // ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«æç”»
    render() {
        print("ğŸ¨ Rendering Mandelbrot fractal...")
        print("Zoom: " + me.zoom + ", Center: (" + me.centerX + ", " + me.centerY + ")")
        
        // ç”»é¢ã®å„ãƒ”ã‚¯ã‚»ãƒ«ã‚’è¨ˆç®—
        y = 0
        loop (y < me.height) {
            x = 0
            loop (x < me.width) {
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã‚’è¤‡ç´ å¹³é¢åº§æ¨™ã«å¤‰æ›
                real = (x - me.width / 2) / (me.width / 4) / me.zoom + me.centerX
                imag = (y - me.height / 2) / (me.height / 4) / me.zoom + me.centerY
                
                c = new ComplexBox(real, imag)
                iterations = me.mandelbrotIterations(c)
                color = me.getColor(iterations)
                
                // ãƒ”ã‚¯ã‚»ãƒ«æç”»
                me.canvas.setFillStyle(color)
                me.canvas.fillRect(x, y, 1, 1)
                
                x = x + 2  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚2ãƒ”ã‚¯ã‚»ãƒ«åˆ»ã¿
            }
            y = y + 2
            
            // é€²è¡ŒçŠ¶æ³è¡¨ç¤º
            if y % 20 == 0 {
                progress = (y * 100) / me.height
                print("Progress: " + progress + "%")
            }
        }
        
        // æƒ…å ±è¡¨ç¤º
        me.canvas.setFillStyle("white")
        me.canvas.fillText("Mandelbrot Set - Zoom: " + me.zoom, 10, 20)
        me.canvas.fillText("Everything is Box Mathematics!", 10, 40)
    }
    
    // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
    zoomIn(factor) {
        me.zoom = me.zoom * factor
    }
    
    // ä¸­å¿ƒç§»å‹•
    setCenter(x, y) {
        me.centerX = x
        me.centerY = y
    }
}

// ğŸš€ ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«ç”Ÿæˆé–‹å§‹ï¼
print("Creating Mandelbrot fractal generator...")
mandelbrot = new MandelbrotBox("fractal-canvas", 400, 400)

// åŸºæœ¬ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«æç”»
mandelbrot.render()

print("ğŸŒŸ Generated beautiful Mandelbrot fractal!")
print("ğŸ”¢ Complex number calculations with ComplexBox")
print("ğŸ¨ Mathematical art through WebCanvasBox")

// ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ç‰ˆã‚‚ç”Ÿæˆ
print("ğŸ“Š Creating zoomed version...")
mandelbrot.setCenter(-0.8, 0.156)  // èˆˆå‘³æ·±ã„é ˜åŸŸ
mandelbrot.zoomIn(2.0)
mandelbrot.render()

// æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
print(DEBUG.memoryReport())
print("âœ¨ Mathematics is beautiful with Everything is Box!")
print("ğŸ± Complex numbers, iterations, colors - all unified as Boxes!")