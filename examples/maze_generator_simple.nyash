// ğŸŒ€ ã‚·ãƒ³ãƒ—ãƒ«ãªè¿·è·¯ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - outboxã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ´»ç”¨ãƒ‡ãƒ¢
// ã‚ˆã‚Šå˜ç´”ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ç¢ºå®Ÿã«å‹•ãè¿·è·¯ã‚’ç”Ÿæˆ

print("=== Simple Maze Generator with outbox ===")

// Cellã®å®šç¾©ï¼ˆè¿·è·¯ã®1ãƒã‚¹ï¼‰
box Cell {
    init { x, y, isWall }
    
    Cell(x_pos, y_pos, wall_flag) {
        me.x = x_pos
        me.y = y_pos
        me.isWall = wall_flag
    }
    
    makePassage() {
        me.isWall = false
    }
    
    makeWall() {
        me.isWall = true
    }
}

// è¿·è·¯Boxå®šç¾©
box Maze {
    init { width, height, cells }
    
    Maze(w, h) {
        me.width = w
        me.height = h
        me.cells = new MapBox()
        
        // åˆæœŸåŒ–ï¼šå…¨éƒ¨å£ã«ã™ã‚‹
        local y, x, key, cell
        y = 0
        loop(y < h) {
            x = 0
            loop(x < w) {
                key = x + "," + y
                cell = new Cell(x, y, true)  // åˆæœŸçŠ¶æ…‹ã¯å£
                me.cells.set(key, cell)
                x = x + 1
            }
            y = y + 1
        }
    }
    
    // åº§æ¨™ã‹ã‚‰Cellã‚’å–å¾—
    getCell(x, y) {
        local key
        key = x + "," + y
        return me.cells.get(key)
    }
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªè¿·è·¯ç”Ÿæˆ
    generateSimple() {
        print("Generating simple maze...")
        
        // å¥‡æ•°åº§æ¨™ã‚’é€šè·¯ã«ã™ã‚‹ï¼ˆå˜ç´”ãªã‚°ãƒªãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        local y, x, cell
        y = 1
        loop(y < me.height - 1) {
            x = 1
            loop(x < me.width - 1) {
                // ä¸¡æ–¹ã¨ã‚‚å¥‡æ•°ãªã‚‰é€šè·¯
                if isOddSimple(x) && isOddSimple(y) {
                    cell = me.getCell(x, y)
                    cell.makePassage()
                }
                x = x + 1
            }
            y = y + 1
        }
        
        // å¶æ•°è¡Œã®å¥‡æ•°åˆ—ã«é€šè·¯ã‚’è¿½åŠ ï¼ˆç¸¦ã®é€šè·¯ï¼‰
        y = 2
        loop(y < me.height - 1) {
            x = 1
            loop(x < me.width - 1) {
                if isEvenSimple(y) && isOddSimple(x) {
                    // 50%ã®ç¢ºç‡ã§é€šè·¯ã«ã™ã‚‹ï¼ˆç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                    if shouldMakePassage(x, y) {
                        cell = me.getCell(x, y)
                        cell.makePassage()
                    }
                }
                x = x + 2
            }
            y = y + 2
        }
        
        // å¥‡æ•°è¡Œã®å¶æ•°åˆ—ã«é€šè·¯ã‚’è¿½åŠ ï¼ˆæ¨ªã®é€šè·¯ï¼‰
        y = 1
        loop(y < me.height - 1) {
            x = 2
            loop(x < me.width - 1) {
                if isOddSimple(y) && isEvenSimple(x) {
                    // 50%ã®ç¢ºç‡ã§é€šè·¯ã«ã™ã‚‹ï¼ˆç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                    if shouldMakePassage(x + 1, y + 1) {
                        cell = me.getCell(x, y)
                        cell.makePassage()
                    }
                }
                x = x + 2
            }
            y = y + 2
        }
    }
    
    // è¿·è·¯ã‚’è¡¨ç¤º
    display() {
        print("\nGenerated Maze:")
        local y, x, line, cell
        y = 0
        loop(y < me.height) {
            line = ""
            x = 0
            loop(x < me.width) {
                cell = me.getCell(x, y)
                if cell.isWall {
                    line = line + "â– "
                } else {
                    line = line + "  "
                }
                x = x + 1
            }
            print(line)
            y = y + 1
        }
    }
}

// MazeFactoryå®šç¾©
box MazeFactory {
    init { dummy }
}

// staticé–¢æ•°ã§outboxã‚’ä½¿ç”¨
static function MazeFactory.createSimple(width, height) {
    print("MazeFactory.createSimple called with size: " + width + "x" + height)
    
    // outboxå¤‰æ•°ã§è¿·è·¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    outbox maze
    maze = new Maze(width, height)
    
    // è¿·è·¯ã‚’ç”Ÿæˆ
    maze.generateSimple()
    
    return maze  // æ‰€æœ‰æ¨©ã‚’å‘¼ã³å‡ºã—å´ã«ç§»è»¢
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function isOddSimple(n) {
    // 2ã§å‰²ã£ãŸä½™ã‚ŠãŒ1ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    local div2
    div2 = n * 0  // 0ã§åˆæœŸåŒ–
    loop(div2 * 2 + 1 <= n) {
        div2 = div2 + 1
    }
    return (n == div2 * 2 + 1)
}

function isEvenSimple(n) {
    // 2ã§å‰²ã£ãŸä½™ã‚ŠãŒ0ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    local div2
    div2 = n * 0  // 0ã§åˆæœŸåŒ–
    loop(div2 * 2 < n) {
        div2 = div2 + 1
    }
    return (n == div2 * 2)
}

// ç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ ã§é€šè·¯ã«ã™ã‚‹ã‹æ±ºå®š
function shouldMakePassage(x, y) {
    // åº§æ¨™ãƒ™ãƒ¼ã‚¹ã®ç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ 
    local seed
    seed = (x * 7 + y * 13) - ((x * 7 + y * 13) >= 100) * 100
    return seed < 50
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
print("\n--- Small Maze (11x7) ---")
maze1 = MazeFactory.createSimple(11, 7)
maze1.display()

print("\n--- Medium Maze (21x11) ---")
maze2 = MazeFactory.createSimple(21, 11)
maze2.display()

print("\n=== Simple Maze Generator completed! ===")
print("Note: Outbox successfully transfers maze ownership!")