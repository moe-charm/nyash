// ğŸ”¥ P2PBox Phase 3B: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©Boxé–“ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¨¼
// ç›®æ¨™: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©BoxåŒå£«ã®ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»overrideå®Œå…¨å®Ÿè¨¼

local console
console = new ConsoleBox()
console.log("ğŸ”¥ Phase 3B: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³é©å‘½ï¼")

// 3B.1 BaseNodeBoxï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ï¼‰ä½œæˆ
console.log("\nğŸ“¦ 3B.1 BaseNodeBoxï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ï¼‰å®Ÿè£…")

box BaseNodeBox {
    init { nodeId, messageCount }
    
    pack(id) {
        me.nodeId = id
        me.messageCount = 0
    }
    
    getId() {
        return me.nodeId
    }
    
    sendMessage(target, message) {
        me.messageCount = me.messageCount + 1
        return "BaseNode sent: " + message + " to " + target
    }
    
    getMessageCount() {
        return me.messageCount
    }
}

// 3B.2 ChatNodeBoxï¼ˆBaseNodeBoxã‹ã‚‰ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
console.log("\nğŸ”„ 3B.2 ChatNodeBoxï¼ˆBaseNodeBoxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰å®Ÿè£…")

box ChatNodeBox from BaseNodeBox {
    init { chatHistory, specialFeature }
    
    pack(id, feature) {
        from BaseNodeBox.pack(id)  // è¦ªã®åˆæœŸåŒ–
        me.chatHistory = new ArrayBox()
        me.specialFeature = feature
    }
    
    // 3B.3 sendMessage()ã®override - ãƒ­ã‚°æ©Ÿèƒ½è¿½åŠ 
    override sendMessage(target, message) {
        local logEntry
        logEntry = "[CHAT] " + message + " -> " + target
        me.chatHistory.push(logEntry)
        
        console = new ConsoleBox()
        console.log("ğŸ“¤ ChatNode override: " + logEntry)
        
        // è¦ªã®sendMessage()ã‚’å‘¼ã³å‡ºã—
        return from BaseNodeBox.sendMessage(target, message)
    }
    
    // 3B.4 getId()ã®override - æ‹¡å¼µæƒ…å ±ä»˜ã
    override getId() {
        local baseId
        baseId = from BaseNodeBox.getId()
        return "[" + me.specialFeature + "]" + baseId + "(" + me.getMessageCount() + ")"
    }
    
    // 3B.5 ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
    getChatHistory() {
        return me.chatHistory.length() + " chat messages logged"
    }
    
    getLastChat() {
        if me.chatHistory.length() > 0 {
            return me.chatHistory.get(me.chatHistory.length() - 1)
        } else {
            return "No chats yet"
        }
    }
}

// 3B.6 ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œãƒ†ã‚¹ãƒˆ
console.log("\nğŸš€ 3B.6 ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œãƒ†ã‚¹ãƒˆ")

local baseNode
local chatNode

baseNode = new BaseNodeBox("base_alice")
chatNode = new ChatNodeBox("chat_bob", "AdvancedChat")

console.log("âœ… ãƒãƒ¼ãƒ‰ä½œæˆå®Œäº†")
console.log("BaseNode ID: " + baseNode.getId())
console.log("ChatNode ID: " + chatNode.getId())  // overrideç‰ˆ

// 3B.7 Overrideæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
console.log("\nğŸ”„ 3B.7 Override sendMessage()ãƒ†ã‚¹ãƒˆ")

local result1
local result2

result1 = baseNode.sendMessage("target1", "Hello from base")
console.log("Baseé€ä¿¡çµæœ: " + result1)

result2 = chatNode.sendMessage("target2", "Hello from chat")  // overrideç‰ˆ
console.log("Chaté€ä¿¡çµæœ: " + result2)

// 3B.8 è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
console.log("\nğŸ“¨ 3B.8 è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ†ã‚¹ãƒˆ")

local result3
local result4

result3 = chatNode.sendMessage("alice", "First chat message")
result4 = chatNode.sendMessage("bob", "Second chat message")

console.log("çµæœ3: " + result3)
console.log("çµæœ4: " + result4)

// 3B.9 ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ç¶™æ‰¿ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ
console.log("\nğŸ“Š 3B.9 ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ç¶™æ‰¿æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ")

console.log("Chatå±¥æ­´: " + chatNode.getChatHistory())
console.log("æœ€æ–°Chat: " + chatNode.getLastChat())
console.log("æ›´æ–°ã•ã‚ŒãŸID: " + chatNode.getId())  // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ç¢ºèª

// ç¶™æ‰¿ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã®å‹•ä½œç¢ºèª
console.log("ç¶™æ‰¿ã•ã‚ŒãŸã‚«ã‚¦ãƒ³ãƒˆ: " + chatNode.getMessageCount())

// 3B.10 ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰ã¨ã®æ¯”è¼ƒ
console.log("\nâš–ï¸ 3B.10 BaseNode vs ChatNodeæ¯”è¼ƒ")

console.log("BaseNode ã‚«ã‚¦ãƒ³ãƒˆ: " + baseNode.getMessageCount())
console.log("ChatNode ã‚«ã‚¦ãƒ³ãƒˆ: " + chatNode.getMessageCount())

console.log("BaseNode ID: " + baseNode.getId())
console.log("ChatNode ID: " + chatNode.getId())

// 3B.11 Revolutionæˆæœç¢ºèª
console.log("\nğŸ‰ 3B.11 ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³é©å‘½æˆæœ")

console.log("âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©Boxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³: å®Œå…¨æˆåŠŸ")
console.log("âœ… Overrideæ©Ÿèƒ½: sendMessage()ãƒ»getId()æ­£å¸¸å‹•ä½œ")
console.log("âœ… ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰: getChatHistory()ãƒ»getLastChat()è¿½åŠ ")
console.log("âœ… è¦ªæ©Ÿèƒ½ç¶™æ‰¿: getMessageCount()æ­£å¸¸å‹•ä½œ")
console.log("âœ… fromæ§‹æ–‡: è¦ªãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—æˆåŠŸ")

console.log("\nğŸŒŸ æœ€çµ‚çµ±è¨ˆ:")
console.log("- ChatNodeé€ä¿¡æ•°: " + chatNode.getMessageCount())
console.log("- Chatå±¥æ­´çµ±è¨ˆ: " + chatNode.getChatHistory())
console.log("- æœ€æ–°Chatãƒ­ã‚°: " + chatNode.getLastChat())

console.log("\nğŸ”¥ğŸ”¥ğŸ”¥ Phase 3B: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³é©å‘½å®Œå…¨é”æˆï¼ ğŸ”¥ğŸ”¥ğŸ”¥")
console.log("Everything is Box + ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ + Override = å®Œå…¨å‹•ä½œå®Ÿè¨¼ï¼")