// ğŸ”¥ P2PBox Phase 3: ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»overrideé©å‘½ï¼
// ç›®æ¨™: P2PBoxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ãƒ»Everything is Boxå“²å­¦ã®å®Œå…¨å®Ÿè¨¼

local console
console = new ConsoleBox()
console.log("ğŸ”¥ Phase 3: ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»overrideé©å‘½é–‹å§‹ï¼")

// 3.1 P2PBoxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ - ChatNodeBoxå®Ÿè£…
console.log("\nğŸ“¦ 3.1 ChatNodeBoxï¼ˆP2PBoxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰å®Ÿè£…")

// Nyashã®ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æ–‡ï¼šbox Child from Parent
box ChatNodeBox from P2PBox {
    init { chatHistory, messageCount }
    
    pack(nodeId, transport) {
        from P2PBox.pack(nodeId, transport)  // è¦ªã®åˆæœŸåŒ–
        me.chatHistory = new ArrayBox()
        me.messageCount = 0
    }
    
    // 3.2 send()ãƒ¡ã‚½ãƒƒãƒ‰ã®override - ãƒ­ã‚°æ©Ÿèƒ½è¿½åŠ 
    override send(to, intent) {
        console = new ConsoleBox()
        console.log("ğŸ“¤ [ChatNode] Sending: " + intent.getName() + " to " + to)
        
        // å±¥æ­´ã«è¨˜éŒ²
        local logEntry
        logEntry = "SENT:" + intent.getName() + ":" + to
        me.chatHistory.push(logEntry)
        me.messageCount = me.messageCount + 1
        
        // è¦ªã®send()ã‚’å‘¼ã³å‡ºã—
        return from P2PBox.send(to, intent)
    }
    
    // 3.3 getNodeId()ã®override - æ‹¡å¼µæƒ…å ±ä»˜ã
    override getNodeId() {
        local baseId
        baseId = from P2PBox.getNodeId()
        return "[Chat]" + baseId + "(" + me.messageCount + "msgs)"
    }
    
    // 3.4 ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
    getChatStats() {
        return "Messages: " + me.messageCount + ", History: " + me.chatHistory.length()
    }
    
    getLastMessage() {
        if me.chatHistory.length() > 0 {
            return me.chatHistory.get(me.chatHistory.length() - 1)
        } else {
            return "No messages"
        }
    }
}

// 3.5 ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œãƒ†ã‚¹ãƒˆ
console.log("\nğŸš€ 3.5 ChatNodeBoxä½œæˆãƒ»å‹•ä½œãƒ†ã‚¹ãƒˆ")

local chatAlice
local regularBob

chatAlice = new ChatNodeBox("alice", "inprocess")
regularBob = new P2PBox("bob", "inprocess")

console.log("âœ… ChatNodeBoxä½œæˆå®Œäº†")
console.log("ChatAlice ID: " + chatAlice.getNodeId())  // overrideç‰ˆ
console.log("Regular Bob ID: " + regularBob.getNodeId())  // é€šå¸¸ç‰ˆ

// 3.6 overrideæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
console.log("\nğŸ”„ 3.6 Override send()ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ")

local chatMsg1
local chatMsg2

chatMsg1 = new IntentBox("chat", "Hello from ChatNode!")
chatMsg2 = new IntentBox("info", "System message")

console.log("é€ä¿¡ãƒ†ã‚¹ãƒˆ1:")
local result1
result1 = chatAlice.send("bob", chatMsg1)  // overrideç‰ˆsend
console.log("é€ä¿¡çµæœ: " + result1)

console.log("\né€ä¿¡ãƒ†ã‚¹ãƒˆ2:")
local result2
result2 = chatAlice.send("bob", chatMsg2)  // overrideç‰ˆsend
console.log("é€ä¿¡çµæœ: " + result2)

// 3.7 ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ
console.log("\nğŸ“Š 3.7 ChatNodeBoxç‹¬è‡ªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ")

console.log("Chatçµ±è¨ˆ: " + chatAlice.getChatStats())
console.log("æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: " + chatAlice.getLastMessage())
console.log("æ›´æ–°ã•ã‚ŒãŸID: " + chatAlice.getNodeId())  // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ç¢ºèª

// 3.8 é€šå¸¸P2PBoxã¨ã®æ¯”è¼ƒãƒ†ã‚¹ãƒˆ
console.log("\nâš–ï¸ 3.8 ChatNodeBox vs é€šå¸¸P2PBoxæ¯”è¼ƒ")

local normalMsg
normalMsg = new IntentBox("normal", "Normal P2P message")

console.log("é€šå¸¸P2PBoxé€ä¿¡:")
local normalResult
normalResult = regularBob.send("alice", normalMsg)  // é€šå¸¸ç‰ˆsend
console.log("é€šå¸¸é€ä¿¡çµæœ: " + normalResult)

console.log("\nChatNodeBoxé€ä¿¡:")
local chatResult
chatResult = chatAlice.send("bob", normalMsg)  // overrideç‰ˆsend
console.log("Chaté€ä¿¡çµæœ: " + chatResult)

// 3.9 Revolutionæˆæœç¢ºèª
console.log("\nğŸ‰ 3.9 Everything is Box + ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³é©å‘½æˆæœ")

console.log("âœ… P2PBoxãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³: æˆåŠŸ")
console.log("âœ… Overrideæ©Ÿèƒ½: send()ãƒ»getNodeId()æ­£å¸¸å‹•ä½œ")
console.log("âœ… ç‹¬è‡ªãƒ¡ã‚½ãƒƒãƒ‰: getChatStats()ãƒ»getLastMessage()è¿½åŠ ")
console.log("âœ… è¦ªæ©Ÿèƒ½ç¶™æ‰¿: isReachable()ãªã©å…¨ã¦åˆ©ç”¨å¯èƒ½")
console.log("âœ… ãƒ­ã‚°æ©Ÿèƒ½: é€ä¿¡å±¥æ­´è¨˜éŒ²ãƒ»ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½")

console.log("\nğŸŒŸ æœ€çµ‚çµ±è¨ˆ:")
console.log("- é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·æ•°: " + chatAlice.getChatStats())
console.log("- ãƒãƒ¼ãƒ‰IDæ‹¡å¼µè¡¨ç¤º: " + chatAlice.getNodeId())
console.log("- æœ€æ–°ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª: " + chatAlice.getLastMessage())

console.log("\nğŸ”¥ğŸ”¥ğŸ”¥ Phase 3: ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»overrideé©å‘½å®Œå…¨é”æˆï¼ ğŸ”¥ğŸ”¥ğŸ”¥")
console.log("Everything is Boxå“²å­¦ + P2Pé€šä¿¡ + ãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ = å®Œå…¨çµ±åˆæˆåŠŸï¼")