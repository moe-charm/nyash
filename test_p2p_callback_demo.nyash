// ğŸ§ª P2PBox ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œãƒ‡ãƒ¢
// å®Ÿéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œã®æ§˜å­ã‚’ç¢ºèª

print("=== P2PBox Callback Demo ===")

// é€šä¿¡ä¸–ç•Œã‚’ä½œæˆ
local world
world = new IntentBox()

print("\n1. Creating chat nodes...")
local alice
local bob
alice = new P2PBox("alice", world)
bob = new P2PBox("bob", world)
print("âœ… Alice and Bob joined the chat")

// ç¾åœ¨ã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿéš›ã«å®Ÿè¡Œã§ããªã„ãŸã‚ã€
// ç™»éŒ²ã¨é€ä¿¡ã®æµã‚Œã‚’ç¤ºã™ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
print("\n2. Registering message handlers...")
print("âš ï¸  Note: Callbacks are registered but not executed in current implementation")
print("   (MethodBox integration pending)")

// Bobã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ²
bob.on("chat", "bob_chat_handler")
bob.on("typing", "bob_typing_handler")
bob.on("image", "bob_image_handler")
print("âœ… Bob's handlers registered")

// Aliceã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ²
alice.on("chat", "alice_chat_handler") 
alice.on("reply", "alice_reply_handler")
print("âœ… Alice's handlers registered")

print("\n3. Message exchange simulation...")

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
local chatMsg
chatMsg = new MapBox()
chatMsg.set("text", "Hi Bob! How are you?")
chatMsg.set("timestamp", 1234567890)
alice.send("chat", chatMsg, "bob")
print("Alice â†’ Bob: Hi Bob! How are you?")

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é€šçŸ¥
alice.send("typing", true, "bob")
print("Alice â†’ Bob: [typing...]")

// ç”»åƒé€ä¿¡
local imageMsg
imageMsg = new MapBox()
imageMsg.set("url", "https://example.com/photo.jpg")
imageMsg.set("caption", "Check out this photo!")
alice.send("image", imageMsg, "bob")
print("Alice â†’ Bob: [sent an image]")

// è¿”ä¿¡
local replyMsg
replyMsg = new MapBox()
replyMsg.set("text", "I'm doing great, thanks!")
replyMsg.set("replyTo", "Hi Bob! How are you?")
bob.send("reply", replyMsg, "alice")
print("Bob â†’ Alice: I'm doing great, thanks!")

print("\n4. Broadcast demo...")
// å…¨å“¡ã¸ã®é€šçŸ¥
local announcement
announcement = new MapBox()
announcement.set("type", "system")
announcement.set("message", "Welcome to NyaMesh P2P Chat!")
alice.broadcast("announcement", announcement)
print("System broadcast: Welcome to NyaMesh P2P Chat!")

print("\n5. Testing message queue...")
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†
local processed
processed = world.processMessages()
print("Messages in queue: " + processed)

print("\n6. Dynamic listener management...")
// å‹•çš„ãªãƒªã‚¹ãƒŠãƒ¼ç®¡ç†
alice.off("chat")
print("âœ… Alice unsubscribed from chat")

// è§£é™¤å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå—ä¿¡ã•ã‚Œãªã„ï¼‰
bob.send("chat", "Are you still there?", "alice")
print("Bob â†’ Alice: Are you still there? (Alice won't receive)")

print("\n=== Demo Complete ===")
print("\nğŸ“ Summary:")
print("- IntentBox creates communication worlds")
print("- P2PBox nodes can join and exchange messages")
print("- Listeners can be dynamically added/removed")
print("- LocalTransport handles in-process messaging")
print("- Full callback execution requires MethodBox integration")